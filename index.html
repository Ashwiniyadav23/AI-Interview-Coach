<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced AI Interview Coach</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6a5af9;
      --secondary-color: #f7f7f9;
      --text-color: #333;
      --light-text-color: #666;
      --success-color: #28a745;
      --error-color: #dc3545;
      --white-color: #fff;
      --border-radius: 12px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --gradient-bg: linear-gradient(90deg, #8e44ad, var(--primary-color));
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--secondary-color);
      color: var(--text-color);
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: var(--white-color);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      transition: all 0.5s ease-in-out;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* --- App Sections --- */
    .app-section {
      display: none;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      width: 100%;
    }
    .app-section.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* --- Header --- */
    h1, h2 {
      color: var(--primary-color);
      text-align: center;
      margin-top: 0;
      font-weight: 600;
    }
    p {
      color: var(--light-text-color);
      line-height: 1.6;
      text-align: center;
      margin-bottom: 2rem;
    }

    /* --- Form Elements --- */
    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: 'Poppins', sans-serif;
      resize: vertical;
      box-sizing: border-box;
      margin-top: 0.5rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(106, 90, 249, 0.2);
        outline: none;
    }

    button {
      display: block;
      width: 100%;
      padding: 1rem;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--white-color);
      background: var(--gradient-bg);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1.5rem;
      overflow: hidden;
      position: relative;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(106, 90, 249, 0.45);
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* --- File Upload --- */
    .upload-box {
      border: 2px dashed var(--primary-color);
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      background-color: #fafaff;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }
    .upload-box:hover {
      background-color: #f5f3ff;
      border-color: #8e44ad;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(106, 90, 249, 0.15);
    }
    .upload-box input[type="file"] {
      display: none;
    }
    .upload-box label {
      font-weight: 500;
      color: var(--primary-color);
      cursor: pointer;
    }
    #fileName {
      margin-top: 1rem;
      color: var(--light-text-color);
      font-style: italic;
    }

    /* --- API Key Input Specifics --- */
    .api-key-input {
        margin-top: 2rem;
        text-align: left;
    }
    .api-key-input label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-color);
    }


    /* --- Question Count Selection --- */
    .question-options {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
    .question-option label {
        display: block;
        padding: 1rem 1.5rem;
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        color: var(--primary-color);
        background-color: #eef;
        transition: all 0.3s ease;
    }
    .question-option input[type="radio"] {
        display: none;
    }
    .question-option input[type="radio"]:checked + label {
        background: var(--gradient-bg);
        color: var(--white-color);
        border-color: var(--primary-color);
        box-shadow: 0 4px 10px rgba(106, 90, 249, 0.2);
        transform: translateY(-2px);
    }
    .question-option label:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(106, 90, 249, 0.1);
    }

    /* --- Questions & Feedback Cards Layout --- */
    #questionsContainer, #resultsContainer {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    @media (min-width: 768px) {
        #resultsContainer {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }


    .question-card, .feedback-card {
      background: var(--white-color);
      border: 1px solid #eee;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      animation: fadeInSlideUp 0.6s forwards ease-out; /* Removed animation delay dependency */
    }

    .question-card b, .feedback-card b {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
      font-size: 1.1rem;
    }
    /* NEW: Specific style for the main question text */
    .question-card .question-text {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 1rem;
    }
    
    #questionProgress {
        font-weight: 600;
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 1rem;
    }

    .feedback-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .score {
        font-weight: 600;
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
        color: var(--white-color);
        transition: background-color 0.3s ease;
        font-size: 0.9rem;
    }
    .score.high { background-color: var(--success-color); }
    .score.medium { background-color: #ffc107; }
    .score.low { background-color: var(--error-color); }
    .score.zero { background-color: #6c757d; }


    /* --- Total Score Display --- */
    #totalScoreDisplay {
        background: var(--gradient-bg);
        color: var(--white-color);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        text-align: center;
        margin-top: 2rem;
        margin-bottom: 1rem;
        box-shadow: 0 6px 20px rgba(106, 90, 249, 0.3);
        animation: fadeIn 0.8s ease-out;
    }
    #totalScoreDisplay h3 {
        margin: 0.5rem 0;
        font-size: 1.8rem;
        font-weight: 600;
    }
    #totalScoreDisplay p {
        margin-top: 0.5rem;
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
    }


    /* --- Loader and Messages --- */
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    .mini-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
        margin: 1rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader p { margin-top: 1rem; font-weight: 500; }

    .error-message {
      background-color: #fff0f1;
      border: 1px solid var(--error-color);
      color: var(--error-color);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-top: 1rem;
      animation: fadeIn 0.5s ease-out;
    }
    
    .divider-text {
        text-align: center;
        margin: 1.5rem 0;
        font-weight: 500;
        color: var(--light-text-color);
    }
    
    /* --- New Feature Styles --- */
    .results-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .button-secondary {
        background: var(--white-color);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
    }
    .button-secondary:hover {
        background: #f5f3ff;
        color: var(--primary-color);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(106, 90, 249, 0.15);
    }
    .improve-button {
        background: #eef;
        color: var(--primary-color);
        font-size: 0.9rem;
        padding: 0.6rem 1rem;
        margin-top: 1rem;
        width: auto;
        display: inline-block;
    }
    .improve-button:hover {
        background: #e0dcfd;
        box-shadow: 0 4px 15px rgba(106, 90, 249, 0.2);
    }
    .improved-answer-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-left: 4px solid var(--success-color);
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 8px;
        animation: fadeIn 0.5s ease-out;
    }
    .improved-answer-box b {
        color: var(--success-color);
    }

    /* --- Security Warning --- */
    .security-warning {
        background-color: #fffbe6;
        border: 1px solid #ffc107;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 2rem;
        animation: fadeIn 0.5s ease-out;
    }
    .security-warning h4 { margin-top: 0; color: #b08000; }
    .security-warning code { background-color: #f0f0f0; padding: 2px 5px; border-radius: 4px; }

    /* Keyframe Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes fadeInSlideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Print Styles --- */
    @media print {
        body {
            padding: 0;
            background-color: var(--white-color);
        }
        .container {
            box-shadow: none;
            max-width: 100%;
            padding: 1rem;
        }
        .app-section {
            display: none !important; /* Hide all sections by default */
        }
        #resultsSection.active {
            display: block !important; /* Only show active results section */
        }
        #totalScoreDisplay, .feedback-card {
            box-shadow: none;
            border: 1px solid #ccc;
            page-break-inside: avoid;
        }
        .results-actions, .improve-button {
            display: none; /* Hide all buttons */
        }
        h1, h2, p {
            margin-bottom: 1.5rem;
        }
        #resultsContainer {
             grid-template-columns: 1fr;
        }
    }

  </style>
</head>
<body>

  <div class="container">

    <!-- Section 1: File Upload -->
    <div id="uploadSection" class="app-section active">
      <h1>🤖 AI Interview Coach</h1>
      <p>Upload your Resume, a Job Description, or paste any relevant text to generate personalized interview questions.</p>
      
      <div class="api-key-input">
          <label for="apiKeyInput">Your Gemini API Key:</label>
          <input type="password" id="apiKeyInput" placeholder="Enter your Google Gemini API key here" oninput="checkInputsAndEnableNext()">
          <p style="font-size: 0.85rem; color: var(--light-text-color); margin-top: 0.5rem; text-align: left;">
            Obtain your key from <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary-color);">Google AI Studio</a>.
          </p>
      </div>

      <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" accept=".pdf,.txt" onchange="displayFileName()">
        <label for="fileInput">Click to select a .PDF or .TXT file</label>
        <div id="fileName">No file selected</div>
      </div>

      <div class="divider-text">OR</div>

      <div>
        <label for="textInput" style="font-weight: 500; color: var(--text-color);">Paste Content Directly:</label>
        <textarea id="textInput" rows="6" placeholder="Paste a job description or other relevant text here..." oninput="checkInputsAndEnableNext()"></textarea>
      </div>

      <button id="nextToCountBtn" onclick="handleFile()" disabled>Next</button>
       
    </div>

    <!-- Section 1.5: Choose Question Count -->
    <div id="questionCountSection" class="app-section">
        <h2>🔢 Choose Interview Length</h2>
        <p>How many questions would you like to generate for your practice interview?</p>
        <div class="question-options">
            <div class="question-option">
                <input type="radio" id="q10" name="questionCount" value="10" checked>
                <label for="q10">10 Questions</label>
            </div>
            <div class="question-option">
                <input type="radio" id="q20" name="questionCount" value="20">
                <label for="q20">20 Questions</label>
            </div>
            <div class="question-option">
                <input type="radio" id="q30" name="questionCount" value="30">
                <label for="q30">30 Questions</label>
            </div>
            <div class="question-option">
                <input type="radio" id="q40" name="questionCount" value="40">
                <label for="q40">40 Questions</label>
            </div>
        </div>
        <button onclick="startGeneratingQuestions()">Generate Questions</button>
    </div>


    <!-- Section 2: Loading -->
    <div id="loadingSection" class="app-section">
      <div class="loader">
        <div class="spinner"></div>
        <p id="loadingText">Analyzing your document...</p>
      </div>
    </div>

    <!-- Section 3: Answering Questions -->
    <div id="questionsSection" class="app-section">
      <h2>📝 Your Custom Interview</h2>
      <p id="questionProgress"></p> <!-- NEW: Progress text will be injected here -->
      <div id="questionsContainer">
          <!-- A single question card will be injected here by JS -->
      </div>
      <!-- NEW: This button is now multi-purpose -->
      <button id="nextQuestionBtn" onclick="handleNextOrSubmit()"></button>
    </div>

    <!-- Section 4: Results -->
    <div id="resultsSection" class="app-section">
      <h2>🏆 Your Feedback Report</h2>
      <p>Here's a detailed analysis of your answers. Review the feedback to improve your interviewing skills.</p>
      <div id="totalScoreDisplay">
        <!-- Total score will be inserted here by JS -->
      </div>
      <div id="resultsContainer"></div>
      <div class="results-actions">
        <button onclick="startOver()" class="button-secondary">Start Over</button>
        <button onclick="printResults()">🖨️ Print Report</button>
      </div>
    </div>

  </div>

  <script>
    // --- State Management ---
    let questionsAndAnswers = [];
    let feedbacksCache = []; 
    let selectedFileContent = "";
    let selectedQuestionCount = 10;
    let currentQuestionIndex = 0; // NEW: To track the current question

    // --- DOM Elements ---
    const uploadSection = document.getElementById('uploadSection');
    const apiKeyInput = document.getElementById('apiKeyInput'); 
    const textInput = document.getElementById('textInput'); 
    const questionCountSection = document.getElementById('questionCountSection');
    const loadingSection = document.getElementById('loadingSection');
    const questionsSection = document.getElementById('questionsSection');
    const resultsSection = document.getElementById('resultsSection');
    const loadingText = document.getElementById('loadingText');
    const nextToCountBtn = document.getElementById('nextToCountBtn');
    const totalScoreDisplay = document.getElementById('totalScoreDisplay');

    // --- Page Load / Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const storedApiKey = localStorage.getItem('geminiApiKey');
        if (storedApiKey) {
            apiKeyInput.value = storedApiKey;
        }
        checkInputsAndEnableNext();
    });

    // --- UI Navigation ---
    function showSection(section) {
      const activeSection = document.querySelector('.app-section.active');
      if (activeSection) {
        activeSection.classList.remove('active');
        setTimeout(() => {
          section.classList.add('active');
        }, 500);
      } else {
        section.classList.add('active');
      }
    }

    function checkInputsAndEnableNext() {
        const fileSelected = document.getElementById("fileInput").files.length > 0;
        const textPasted = textInput.value.trim() !== '';
        const apiKeyEntered = apiKeyInput.value.trim() !== '';
        nextToCountBtn.disabled = !((fileSelected || textPasted) && apiKeyEntered);
    }

    function displayFileName() {
        const file = document.getElementById("fileInput").files[0];
        const fileNameDiv = document.getElementById('fileName');
        if (file) {
            fileNameDiv.textContent = `Selected: ${file.name}`;
            textInput.value = ''; 
        } else {
            fileNameDiv.textContent = 'No file selected';
        }
        checkInputsAndEnableNext();
    }

    function startOver() {
        questionsAndAnswers = [];
        feedbacksCache = [];
        selectedFileContent = "";
        selectedQuestionCount = 10;
        currentQuestionIndex = 0;
        document.getElementById('fileInput').value = null;
        textInput.value = '';
        displayFileName();
        document.getElementById('questionsContainer').innerHTML = '';
        document.getElementById('resultsContainer').innerHTML = '';
        totalScoreDisplay.innerHTML = '';
        document.getElementById('q10').checked = true; 
        checkInputsAndEnableNext();
        showSection(uploadSection);
    }

    // --- Core Logic ---
    async function handleFile() {
      const currentApiKey = apiKeyInput.value.trim();
      if (!currentApiKey) {
        alert("Please enter your Gemini API key.");
        return;
      }
      localStorage.setItem('geminiApiKey', currentApiKey);

      loadingText.textContent = "Analyzing your input...";
      showSection(loadingSection);

      try {
        const pastedText = textInput.value.trim();
        if (pastedText) {
            selectedFileContent = pastedText;
        } else {
            const file = document.getElementById("fileInput").files[0];
            if (!file) {
                showError(uploadSection, "No input provided. Please either paste text or upload a file.");
                return;
            }
            if (file.type === "application/pdf") {
              selectedFileContent = await parsePDF(file);
            } else {
              selectedFileContent = await file.text();
            }
        }
        showSection(questionCountSection);
      } catch (error) {
        console.error("Error handling input:", error);
        showError(uploadSection, `Failed to process the input. Error: ${error.message}. Please try a different file/text or check the console.`);
      }
    }

    function startGeneratingQuestions() {
        const selectedRadio = document.querySelector('input[name="questionCount"]:checked');
        if (selectedRadio) {
            selectedQuestionCount = parseInt(selectedRadio.value);
        }

        if (!selectedFileContent) {
            showError(uploadSection, "No content available. Please provide input again.");
            return;
        }

        loadingText.textContent = `Generating ${selectedQuestionCount} personalized questions...`;
        showSection(loadingSection);

        generateQuestions(selectedFileContent, selectedQuestionCount);
    }


    async function parsePDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      if (typeof pdfjsLib === 'undefined') {
          console.error("pdf.js library not loaded.");
          throw new Error("PDF processing library not available. Please ensure the CDN link for pdf.js is correct.");
      }
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(" ") + "\n";
      }
      return text;
    }

    async function generateQuestions(content, count) {
      const prompt = `Based on the following content, generate an array of ${count} unique, insightful, and relevant interview questions. Mix content-specific questions with common behavioral questions. Return the output as a valid JSON array of strings. For example: ["Question 1?", "Question 2?"]\n\nContent:\n${content}`;
      
      try {
        const responseText = await callGenerativeAPI(prompt);
        const cleanedResponse = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
        const generatedQuestions = JSON.parse(cleanedResponse);
        
        questionsAndAnswers = generatedQuestions.map(q => ({ question: q, answer: "" }));
        
        // NEW: Instead of displaying all, start the sequential process
        startAnsweringProcess();

      } catch (error) {
        console.error("Error generating questions:", error);
        showError(questionCountSection, `The AI failed to generate questions. Error: ${error.message}. Please check your API key, network, or content and try again.`);
      }
    }

    // NEW: Kicks off the one-by-one question display
    function startAnsweringProcess() {
        currentQuestionIndex = 0;
        showCurrentQuestion();
        showSection(questionsSection);
    }
    
    // NEW: Displays only the current question
    function showCurrentQuestion() {
        const container = document.getElementById("questionsContainer");
        const progressText = document.getElementById("questionProgress");
        container.innerHTML = ""; // Clear previous question

        progressText.textContent = `Question ${currentQuestionIndex + 1} of ${questionsAndAnswers.length}`;
        const item = questionsAndAnswers[currentQuestionIndex];

        const questionCard = document.createElement('div');
        questionCard.className = 'question-card';
        questionCard.innerHTML = `
            <p class="question-text">${item.question}</p>
            <textarea id="currentAnswer" rows="6" placeholder="Type your detailed answer here..."></textarea>
        `;
        container.appendChild(questionCard);

        const textarea = document.getElementById('currentAnswer');
        const nextBtn = document.getElementById('nextQuestionBtn');
        
        // Disable button until user types something
        nextBtn.disabled = true;
        textarea.addEventListener('input', () => {
            nextBtn.disabled = textarea.value.trim() === '';
        });

        // Update button text for the last question
        if (currentQuestionIndex === questionsAndAnswers.length - 1) {
            nextBtn.textContent = 'Submit for Feedback';
        } else {
            nextBtn.textContent = 'Next Question →';
        }
        
        textarea.focus();
    }

    // NEW: Handles both moving to the next question and final submission
    function handleNextOrSubmit() {
        const textarea = document.getElementById('currentAnswer');
        // Save the answer regardless of moving next or submitting
        questionsAndAnswers[currentQuestionIndex].answer = textarea.value.trim();

        if (currentQuestionIndex < questionsAndAnswers.length - 1) {
            // Move to the next question
            currentQuestionIndex++;
            showCurrentQuestion();
        } else {
            // This was the last question, so submit
            submitAnswers();
        }
    }

    async function submitAnswers() {
      // MODIFIED: No longer need to read from DOM, answers are already in the array.
      loadingText.textContent = "Evaluating your answers...";
      showSection(loadingSection);
      
      const feedbackPromises = questionsAndAnswers.map(qa => getAnswerFeedback(qa.question, qa.answer));
      
      try {
        feedbacksCache = await Promise.all(feedbackPromises);
        displayResults(feedbacksCache);
        calculateAndDisplayTotalScore(feedbacksCache);
        showSection(resultsSection);
      } catch (error) {
         console.error("Error submitting answers:", error);
         showError(questionsSection, `An error occurred while getting feedback. Error: ${error.message}. Please check your network or API key and try again.`);
      }
    }

    async function getAnswerFeedback(question, answer) {
      if (!answer) {
        return { score: 0, explanation: "No answer was provided. In an interview, it's crucial to attempt every question. This misses a key opportunity to showcase your skills." };
      }
      
      const prompt = `You are an expert interview evaluator. Evaluate the answer based on the question. Provide a score from 0 to 5. The explanation must be CONCISE and ACTIONABLE (2-3 sentences max). For low scores, identify the biggest weakness and suggest a fix. For high scores, praise the key strength and offer one refinement. Return a valid JSON object with "score" (number) and "explanation" (string).
      Question: "${question}"
      Answer: "${answer}"`;

      const responseText = await callGenerativeAPI(prompt);
      const cleanedResponse = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
      return JSON.parse(cleanedResponse);
    }
    
    function displayResults(feedbacks) {
        const container = document.getElementById("resultsContainer");
        container.innerHTML = "";

        feedbacks.forEach((feedback, index) => {
            const qa = questionsAndAnswers[index];
            let scoreClass = 'low';
            if (feedback.score === 0) scoreClass = 'zero';
            else if (feedback.score >= 4) scoreClass = 'high';
            else if (feedback.score >= 3) scoreClass = 'medium';

            const feedbackCard = document.createElement('div');
            feedbackCard.className = 'feedback-card';
            feedbackCard.style.animationDelay = `${index * 0.1}s`; 
            feedbackCard.innerHTML = `
                <div class="feedback-header">
                    <b>Question ${index + 1}</b>
                    <span class="score ${scoreClass}">Score: ${feedback.score}/5</span>
                </div>
                <p><em>${qa.question}</em></p>
                <p><strong>Your Answer:</strong> ${qa.answer || "<em>(No answer provided)</em>"}</p>
                <p><strong>AI Feedback:</strong> ${feedback.explanation}</p>
                <button class="improve-button" id="improveBtn${index}" onclick="improveAnswer(${index})">🤖 Suggest a Better Answer</button>
                <div id="improvedAnswerContainer${index}"></div>
            `;
            container.appendChild(feedbackCard);
        });
    }
    
    async function improveAnswer(index) {
        const button = document.getElementById(`improveBtn${index}`);
        button.disabled = true;
        
        const container = document.getElementById(`improvedAnswerContainer${index}`);
        container.innerHTML = '<div class="mini-spinner"></div>';

        const qa = questionsAndAnswers[index];
        
        const prompt = `You are an expert interview coach. Rewrite the user's answer into a concise, impactful, model "5/5" response (3-5 sentences). Focus on clarity, confidence, and a professional tone. Use the STAR method briefly if it fits. Do not write a long essay. Just provide the new, ideal answer directly.
        Original Question: "${qa.question}"
        User's Answer: "${qa.answer}"
        Model Answer:`;

        try {
            const improvedAnswerText = await callGenerativeAPI(prompt);
            container.innerHTML = `
                <div class="improved-answer-box">
                    <b>💡 Model Answer Suggestion:</b>
                    <p>${improvedAnswerText}</p>
                </div>
            `;
        } catch (error) {
            console.error("Error improving answer:", error);
            container.innerHTML = `<p class="error-message" style="margin-top: 1rem;">Failed to generate a suggestion. ${error.message}</p>`;
        } finally {
            button.style.display = 'none'; 
        }
    }


    function calculateAndDisplayTotalScore(feedbacks) {
        const totalPossibleScore = feedbacks.length * 5;
        const yourTotalScore = feedbacks.reduce((sum, f) => sum + f.score, 0);
        const percentage = totalPossibleScore > 0 ? (yourTotalScore / totalPossibleScore) * 100 : 0;

        let rating = "";
        if (percentage >= 90) {
            rating = "Outstanding Performance!";
        } else if (percentage >= 75) {
            rating = "Excellent Work!";
        } else if (percentage >= 60) {
            rating = "Good Effort, Room for Improvement.";
        } else if (percentage >= 40) {
            rating = "Needs Significant Practice.";
        } else {
            rating = "Time to Refocus and Relearn.";
        }

        totalScoreDisplay.innerHTML = `
            <h3>Your Overall Score: ${yourTotalScore} / ${totalPossibleScore}</h3>
            <p>${percentage.toFixed(0)}% - ${rating}</p>
            <p>Review the individual feedback to pinpoint areas for improvement and practice for your next interview!</p>
        `;
    }
    
    function printResults() {
        window.print();
    }

    // --- Reusable API & Error Functions ---
    async function callGenerativeAPI(prompt) {
        const API_KEY_CURRENT = apiKeyInput.value.trim();
        if (!API_KEY_CURRENT) {
            throw new Error("API key is missing. Please enter your Gemini API key.");
        }

        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY_CURRENT}`;
        
        const body = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: 0.5,
                topK: 1,
                topP: 1,
            }
        };

        const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
        });

        if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
        }

        const data = await response.json();
        if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
            throw new Error("Content was blocked due to safety concerns. Please adjust your input or prompt.");
        }
        if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
             throw new Error("Invalid response structure from API. No text content found.");
        }
        return data.candidates[0].content.parts[0].text;
    }

    function showError(sectionToShow, message) {
        const existingError = document.querySelector('.error-message');
        if (existingError) existingError.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        const button = sectionToShow.querySelector('button');
        if (button) {
            sectionToShow.insertBefore(errorDiv, button);
        } else {
            sectionToShow.appendChild(errorDiv);
        }
        showSection(sectionToShow);
    }

  </script>
</body>
</html>
